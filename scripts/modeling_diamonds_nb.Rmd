---
title: "modeling_diamonds_nb"
author: "Matthew Biggs"
output: html_document
---

Example borrowed from: 
R for Data Science Chapter 24
https://r4ds.had.co.nz/model-building.html

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
options(na.action = na.warn)
```

## Unexpected patterns

It seems like inferior diamonds cost more. Very strange. 

Note that the worst diamond color is J (slightly yellow), and the worst clarity is I1 (inclusions visible to the naked eye).

```{r cars}
ggplot(diamonds, aes(cut, price)) + geom_boxplot()
ggplot(diamonds, aes(color, price)) + geom_boxplot()
ggplot(diamonds, aes(clarity, price)) + geom_boxplot()
```

## Size is a confounding variable

The weight of the diamond is the single most important factor for determining the price of the diamond, and lower quality diamonds tend to be larger.

```{r echo=FALSE}
ggplot(diamonds, aes(carat, price)) + 
  geom_hex(bins = 50)
```

## We can use a model to filter out the size "signal"

We can make it easier to see how the other attributes of a diamond affect its relative price by fitting a model to separate out the effect of carat. 

```{r echo=FALSE}
diamonds2 <- diamonds %>% 
  filter(carat <= 2.5) %>% 
  mutate(lprice = log2(price), lcarat = log2(carat))

ggplot(diamonds2, aes(lcarat, lprice)) + 
  geom_hex(bins = 50)
```


Remove the strong linear pattern. We first make the pattern explicit by fitting a model:

```{r}
mod_diamond <- lm(lprice ~ lcarat, data = diamonds2)
```

```{r}
grid <- diamonds2 %>% 
  data_grid(carat = seq_range(carat, 20)) %>% 
  mutate(lcarat = log2(carat)) %>% 
  add_predictions(mod_diamond, "lprice") %>% 
  mutate(price = 2 ^ lprice)

ggplot(diamonds2, aes(carat, price)) + 
  geom_hex(bins = 50) + 
  geom_line(data = grid, colour = "red", size = 1)

```


If we believe our model, then the large diamonds are much cheaper than expected. What makes us think that large diamonds cost less than expected?

Filter out the linear trend (the effect of `carat`):

```{r}
diamonds2 <- diamonds2 %>% 
  add_residuals(mod_diamond, "lresid")

ggplot(diamonds2, aes(lcarat, lresid)) + 
  geom_hex(bins = 50)
```
Re-plot the price vs quality box plots:

```{r}
ggplot(diamonds2, aes(cut, lresid)) + geom_boxplot()
ggplot(diamonds2, aes(color, lresid)) + geom_boxplot()
ggplot(diamonds2, aes(clarity, lresid)) + geom_boxplot()

```

## More complicated model using size and quality information

```{r}
mod_diamond2 <- lm(lprice ~ lcarat + color + cut + clarity, data = diamonds2)
```

Now plot the residuals based on the more comprehensive model:

```{r}
grid <- diamonds2 %>% 
  data_grid(cut, .model = mod_diamond2) %>% 
  add_predictions(mod_diamond2)

diamonds2 <- diamonds2 %>% 
  add_residuals(mod_diamond2, "lresid2")

ggplot(diamonds2, aes(lcarat, lresid2)) + 
  geom_hex(bins = 50)
```

Which diamonds are likely underpriced?

```{r}
diamonds2 %>% 
  arrange(lresid2) %>%
  head()
```